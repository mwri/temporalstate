{"version":3,"sources":["../lib/temporalstate.js"],"names":["temporalstate","_states","changes","states","val_iter_grp","Object","keys","filter","sn","size","map","iterator","i","next","sort","a","b","change_cmp","length","v","push","st_name","st_val","ts","undefined","RBTree","state","iter","upperBound","data","cur","prev","insert","val","remove","timestamp","rec","reduce","acc","next_rec","cur_rec","name"],"mappings":"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","file":"temporalstate_es5.js","sourcesContent":["import bintrees from 'bintrees';\n\n\nclass temporalstate {\n\n    constructor () {\n\n        this._states = {};\n\n    }\n\n    change_list () {\n\n        let changes = [];\n        let states = this._states;\n\n        let val_iter_grp = Object.keys(states)\n            .filter((sn) => states[sn].size > 0)\n            .map((sn) => states[sn].iterator())\n            .map((i) => [i.next(), i])\n            .sort((a, b) => temporalstate.change_cmp(a[0], b[0]));\n        while (val_iter_grp.length > 0) {\n            let v = val_iter_grp[0][0];\n            let i = val_iter_grp[0][1];\n            changes.push(v);\n            val_iter_grp[0] = [i.next(), i];\n            val_iter_grp = val_iter_grp\n                .filter((a) => a[0] !== null)\n                .sort((a, b) => temporalstate.change_cmp(a[0], b[0]));\n        }\n\n        return changes;\n\n    }\n\n    add_change (st_name, st_val, ts) {\n\n        let states = this._states;\n        \n        if (states[st_name] === undefined)\n            states[st_name] = new bintrees.RBTree(temporalstate.change_cmp);\n\n        let state = states[st_name];\n        let iter = state.upperBound({'timestamp': ts});\n        let next = iter.data();\n        let cur = iter.prev();\n\n        if (cur === null) {\n            state.insert({'timestamp': ts, 'name': st_name, 'val': st_val});\n            if (next !== null && next.val === st_val)\n                state.remove(next);\n        } else if (cur.timestamp === ts) {\n            if (cur.val !== st_val) {\n                let prev = iter.prev();\n                if (prev === null) {\n                    if (st_val === null)\n                        state.remove(cur);\n                    else\n                        cur.val = st_val;\n                    if (next !== null && next.val === st_val)\n                        state.remove(next);\n                } else if (prev.val === st_val) {\n                    state.remove(cur);\n                    if (next !== null && next.val === st_val)\n                        state.remove(next);\n                } else {\n                    cur.val = st_val;\n                }\n            }\n        } else if (cur.val !== st_val) {\n            state.insert({'timestamp': ts, 'name': st_name, 'val': st_val});\n        }\n\n    }\n\n    state (ts, st_name) {\n\n        let states = this._states;\n\n        if (st_name !== undefined) {\n            let state = states[st_name];\n            if (state === undefined)\n                return null;\n            let iter = state.upperBound({timestamp: ts});\n            let rec = iter.prev();\n            return rec === null ? null : rec.val;\n        }\n\n        return Object.keys(states)\n            .filter((sn) => states[sn].size > 0)\n            .reduce((acc, sn) => {\n                let rec = this.state(ts, sn);\n                if (rec !== null)\n                    acc[sn] = rec;\n                return acc;\n            }, {});\n\n    }\n\n    state_detail (ts, st_name) {\n\n        let states = this._states;\n\n        if (st_name !== undefined) {\n            let state = states[st_name];\n            if (state === undefined)\n                return {'from': null, 'to': null};\n            let iter = state.upperBound({timestamp: ts});\n            let next_rec = iter.data();\n            let cur_rec = iter.prev();\n            if (cur_rec === null && next_rec === null)\n                return null;\n            return {\n                'from': cur_rec,\n                'to': next_rec\n            };\n        }\n\n        return Object.keys(states)\n            .sort()\n            .reduce((acc, sn) => {\n                let state = states[sn];\n                let iter = state.upperBound({timestamp: ts});\n                let next_rec = iter.data();\n                let cur_rec = iter.prev();\n                if (cur_rec !== null || next_rec !== null)\n                    acc.push({\n                        'from': cur_rec,\n                        'to': next_rec\n                    });\n                return acc;\n            }, []);\n\n    }\n\n    static change_cmp (a, b) {\n\n        return a.timestamp < b.timestamp ? -1\n            : a.timestamp > b.timestamp ? 1\n            : a.name < b.name ? -1\n            : a.name > b.name ? 1\n            : 0;\n\n    }\n\n}\n\n\nexport default temporalstate;\n"]}